#### H5链接接入流程


#### iOS适配

##### 权限申请描述 

* 在info.plist中添加"Privacy - Camera Usage Description"项，`Type`为String，`Value`为申请相机权限的理由描述文字。
* 在info.plist中添加"Privacy - Microphone Usage Description"项，`Type`为String，`Value`为申请麦克风权限的理由描述文字。
* 在info.plist中添加"Privacy - Location When In Use Usage Description"项，`Type`为String，`Value`为申请使用应用时定位权限的理由描述文字。


##### 支付方式设置

* 微信支付支持：在info.plist中添加"LSApplicationQueriesSchemes"项，`Type`为Array，增加一个子项, `Type`为String，`Value`为"weixin"。  
* 支付宝支持：在info.plist中添加"LSApplicationQueriesSchemes"项，`Type`为Array，增加一个子项, `Type`为String，`Value`为"alipay"。
* 微信支付完成回调：由天下信用后台为用户生成一个"`URL Scheme`"标识（下面以"`PYTXXY`"来示范）, 在项目工程里面的`info`选项卡下`URL Type`分组添加一项，`URL Schemes`的值为"`PYTXXY`"。添加以后在手机上运行一次项目，然后在手机`Safari`浏览器里面输入刚添加的"`PYTXXY://`"，验证是否能跳转到自己的应用。


##### WebView适配

`UIWebView`不需要适配即可拉起支付应用（微信、支付宝，下同），`WKWebView`需要在`WKNavigationDelegate`协议的"`decidePolicyForNavigationAction`"方法中添加对拉起支付应用的处理：

```objc
-(void)webView:(WKWebView *)webView decidePolicyForNavigationAction:(WKNavigationAction *)navigationAction decisionHandler:(void (^)(WKNavigationActionPolicy))decisionHandler
{
    NSURL *url = navigationAction.request.URL;
    //其它需要允许的scheme也可以放在此处
    if ([url.scheme isEqualToString:@"weixin"] || [url.scheme isEqualToString:@"alipay"]) {
        if ( [[UIApplication sharedApplication] canOpenURL:url]) {
            if (@available(iOS 10.0, *)) {
                [[UIApplication sharedApplication] openURL:url options:@{UIApplicationOpenURLOptionUniversalLinksOnly: @NO} completionHandler:nil];
            } else {
                [[UIApplication sharedApplication] openURL:url];
            }
            
            decisionHandler(WKNavigationActionPolicyCancel);
            return;
        }
    }
    
    decisionHandler(WKNavigationActionPolicyAllow);
}
```


#### Android适配

##### 实现WebView支持调起微信、支付宝支付功能


* 打开javaScript 支持  

```
webView.getSettings().setJavaScriptEnabled(true);
```  

* 设置WebViewClient,主要重写shouldOverrideUrlLoading方法，处理微信、支付宝相关schema  

```
webView.setWebViewClient(new WebViewClient() {
    //重写这个过时的方法，不要重写5.0新的方法，以保证兼容5.0以下版本
    @Override
    public boolean shouldOverrideUrlLoading(WebView view, String url) {
        //如果url以weixin://开头，表示要拉起微信；以alipay开头表示要拉起支付宝；以tel:开头表示拔打电话
        if (url.startsWith("weixin://") || url.startsWith("alipay") || url.startsWith("tel:")) {
            try {//try catch 以免崩溃
                Intent intent = new Intent(Intent.ACTION_VIEW);
                intent.setData(Uri.parse(url));
                PackageManager packageManager = getPackageManager();
                if (intent.resolveActivity(packageManager) != null) {
                    startActivity(intent);
                    return true;//处理成功不调用默认实现
                }
            } catch (Exception e) {
            }
        }
        //其它调用默认实现(即return false)
        return super.shouldOverrideUrlLoading(view, url);
    }
});
```  

##### 实现WebView支持调起相机拍摄视频功能

* 设置WebChromeClient,主要重写onShowFileChooser方法，处理WebView拍摄视频功能    

```
webView.setWebChromeClient(new WebChromeClient() {
    //Android 5.0 以下 必须重写此方法
    public void openFileChooser(final ValueCallback<Uri> uploadFile, String acceptType, String capture) {
        if (acceptType != null && acceptType.contains("video")) {//只处理视频
            boolean fromCamera = !TextUtils.isEmpty(capture);
            if (fromCamera) {//只处理拍摄视频
                if (captureVideoFromCamera()) {
                    SimpleActivity.this.uploadFile = uploadFile;
                }
            }
        }
    }

    //Android 5.0 及以上 必须重写此方法
    @RequiresApi(api = Build.VERSION_CODES.LOLLIPOP)
    @Override
    public boolean onShowFileChooser(WebView webView, ValueCallback<Uri[]> filePathCallback, FileChooserParams fileChooserParams) {
        String[] acceptTypes = fileChooserParams.getAcceptTypes();
        if (acceptTypes != null && acceptTypes.length > 0) {
            boolean isVideo = false;
            for (String acceptType : acceptTypes) {
                if (acceptType.contains("video")) {
                    isVideo = true;
                    break;
                }
            }
            if (isVideo) {//只处理视频
                boolean fromCamera = fileChooserParams.isCaptureEnabled();
                if (fromCamera) {//只处理拍摄视频
                    if (captureVideoFromCamera()) {
                        SimpleActivity.this.filePathCallback = filePathCallback;
                        return true;//返回true表示APP处理文件选择
                    }
                }
            }
        }
        return super.onShowFileChooser(webView, filePathCallback, fileChooserParams);
    }
});
```

* 调用系统相机拍摄视频  

```
private boolean captureVideoFromCamera() {
    File cacheDir = null;
    if (Environment.MEDIA_MOUNTED.equals(Environment.getExternalStorageState())) {
        cacheDir = getExternalCacheDir();
    }
    if (cacheDir == null) {
        cacheDir = getCacheDir();
    }
    File outFile = new File(cacheDir, System.currentTimeMillis() + ".mp4");
    Intent intent = new Intent(MediaStore.ACTION_VIDEO_CAPTURE);
    if (Build.VERSION.SDK_INT > Build.VERSION_CODES.M) {//如果api大于Android api23 要替换获取文件Uri方式
        //此方法第二个参数authority的值要用项目中的值来替换,可网上找Android 7.0 FileProvider相关介绍
        Uri uri = FileProvider.getUriForFile(this, getPackageName() + ".h5sdk.fileprovider", outFile);
        intent.putExtra(MediaStore.EXTRA_OUTPUT, uri);
        intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);//加入flag
    } else {
        Uri uri = Uri.fromFile(outFile);
        intent.putExtra(MediaStore.EXTRA_OUTPUT, uri);
        intent.addCategory(Intent.CATEGORY_DEFAULT);
    }
    //调系统相机拍摄视频需要用到相机权限，先判断有没有这个权限
    if (ContextCompat.checkSelfPermission(this, Manifest.permission.CAMERA) == PackageManager.PERMISSION_GRANTED) {//有相机权限
        PackageManager packageManager = getPackageManager();
        if (intent.resolveActivity(packageManager) != null) {
            try {
                startActivityForResult(intent, REQUEST_CODE_RECORDER_VIDEO);
                return true;
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    } else {//没有相机权限
        // TODO: 这里做请求相机权限的处理（网上找Android 6.0权限管理相关介绍）
        Toast.makeText(this, "请开启相机权限", Toast.LENGTH_SHORT).show();
    }
    return false;
}
```

> 注意 Android 6.0 权限管理的使用  
> 注意 Android 7.0 FileProvider file转Uri的使用  

* 拍摄完之后回调H5  

```
@Override
protected void onActivityResult(int requestCode, int resultCode, Intent data) {
    super.onActivityResult(requestCode, resultCode, data);
    Uri uri = null;
    if (requestCode == REQUEST_CODE_RECORDER_VIDEO && resultCode == RESULT_OK && data != null) {
        uri = data.getData();
    }
    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {//android 5.0及以上
        if (filePathCallback != null) {//将拍摄的视频回调给H5
            if (uri != null) {
                filePathCallback.onReceiveValue(new Uri[]{uri});
            } else {
                filePathCallback.onReceiveValue(null);
            }
            filePathCallback = null;
        }
    } else {//android 5.0以下
        if (uploadFile != null) {//将拍摄的视频回调给H5
            if (uri != null) {
                uploadFile.onReceiveValue(uri);
            } else {
                uploadFile.onReceiveValue(null);
            }
            uploadFile = null;
        }
    }
}
```